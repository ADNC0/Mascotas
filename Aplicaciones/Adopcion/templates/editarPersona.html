{% extends './plantilla.html' %}
{% block contenido %}
<div class="row">
  <div class="col-md-3"></div>
  <div class="col-md-6 bg-light p-4 rounded-3 shadow-sm">
    <h1 class="mb-4 text-center">Editar Persona</h1>
<form action="{% url 'procesarEdicionPersona' personaEditar.id_per %}" method="post" enctype="multipart/form-data">
      {% csrf_token %}

      <label for="nombre_per">Nombre:</label>
      <input class="form-control" type="text" name="nombre_per" id="nombre_per" 
             value="{{ personaEditar.nombre_per }}" required><br>

      <label for="apellido_per">Apellido:</label>
      <input class="form-control" type="text" name="apellido_per" id="apellido_per" 
             value="{{ personaEditar.apellido_per }}" required><br>

      <label for="telefono_per">Teléfono:</label>
      <input class="form-control" type="text" name="telefono_per" id="telefono_per" 
             value="{{ personaEditar.telefono_per }}" required><br>

      <label for="correo_per">Correo:</label>
      <input class="form-control" type="email" name="correo_per" id="correo_per" 
             value="{{ personaEditar.correo_per }}" required><br>

      <label for="direccion_per">Dirección:</label>
      <input class="form-control" type="text" name="direccion_per" id="direccion_per" 
             value="{{ personaEditar.direccion_per }}" required><br>

      <label for="documento_per">Documento actual:</label><br>
      {% if personaEditar.documento_per %}
        <a href="{{ personaEditar.documento_per.url }}" download>{{ personaEditar.documento_per.name }}</a><br>
      {% else %}
        Ninguno<br>
      {% endif %}
      <input type="file" name="documento_per" id="documento_per" class="form-control"><br>

      <button class="btn btn-warning w-100" type="submit">
        <i class="fa fa-pen"></i> Actualizar
      </button>
      <a class="btn btn-outline-danger w-100 mt-2" href="/persona">
        <i class="fa fa-times"></i> Cancelar
      </a>
    </form>

    <!-- jQuery Validate -->
    <script>
      // Método personalizado para solo letras
      jQuery.validator.addMethod("lettersonly", function(value, element) {
        return this.optional(element) || /^[a-zA-ZÀ-ÿ\s]+$/.test(value);
      }, "Solo se permiten letras");

      // Método personalizado para solo números
      jQuery.validator.addMethod("digitsOnly", function(value, element) {
        return this.optional(element) || /^[0-9]+$/.test(value);
      }, "Solo se permiten números");

      $("#frm_editar_persona").validate({
        rules: {
          nombre_per: { required: true, minlength: 2, lettersonly: true },
          apellido_per: { required: true, minlength: 2, lettersonly: true },
          telefono_per: { required: true, digitsOnly: true, minlength: 7, maxlength: 10 },
          correo_per: { required: true, email: true },
          direccion_per: { required: true, minlength: 5 }
        },
        messages: {
          nombre_per: {
            required: "Ingrese el nombre",
            lettersonly: "Solo se permiten letras"
          },
          apellido_per: {
            required: "Ingrese el apellido",
            lettersonly: "Solo se permiten letras"
          },
          telefono_per: {
            required: "Ingrese el teléfono",
            digitsOnly: "Solo se permiten números",
            minlength: "Debe tener al menos 7 dígitos",
            maxlength: "Máximo 10 dígitos"
          },
          correo_per: {
            required: "Ingrese el correo electrónico",
            email: "Formato de correo inválido"
          },
          direccion_per: {
            required: "Ingrese la dirección",
            minlength: "Debe tener al menos 5 caracteres"
          }
        },
        errorClass: "text-danger"
      });
    </script>

    <!-- SweetAlert para confirmar la actualización -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      document.getElementById("frm_editar_persona").addEventListener("submit", function(e) {
        e.preventDefault();
        if ($("#frm_editar_persona").valid()) {
          Swal.fire({
            title: "¿Guardar cambios?",
            text: "Se actualizará la información de esta persona.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Sí, actualizar",
            cancelButtonText: "Cancelar"
          }).then((result) => {
            if (result.isConfirmed) {
              this.submit();
            }
          });
        }
      });
    </script>

    <!-- Fileinput -->
    <script>
      $("#documento_per").fileinput({
        language: "es",
        allowedFileExtensions: ["pdf", "jpg", "jpeg", "doc", "docx"],
        showCaption: false,
        dropZoneEnabled: true,
        showClose: false
      });
    </script>
  </div>
  <div class="col-md-3"></div>
</div>
{% endblock %}
